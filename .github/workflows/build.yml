name: CI develop build

# ç’°å¢ƒå¤‰æ•°ã®ä¸­èº«ã‚’ãŠä½¿ã„ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„
env:
  BRANCHES: '{ "develop": "develop-site" }'
  BUILD: yarn generate

# ã“ã“ã¯run:ã§ã¯ç„¡ã„ã®ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã§ãã¾ã›ã‚“ã€‚developãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å¤‰æ›´ã™ã‚‹å ´åˆã¯æ‰‹å‹•ã§å¤‰æ›´ã—ã¦ãã ã•ã„
on:
  push:
    branches:
      - develop

jobs:
  generate:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest]
        node: [14]

    steps:
      - name: Get base branch name
        run: echo "BASE_BRANCH=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_ENV

      - name: Get build branch name
        run: echo "BUILD_BRANCH=${{ fromJson(env.BRANCHES)[env.BASE_BRANCH] }}" >> $GITHUB_ENV

      - name: Checkout ğŸ›
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup node env ğŸ—
        uses: actions/setup-node@v2.1.5
        with:
          node-version: ${{ matrix.node }}

      - name: Setup config ğŸ“
        run: |
          git config --local user.email "githubactions@example.com"
          git config --local user.name "github actions"
          git config --local pull.rebase false

      - name: Get yarn cache directory path ğŸ› 
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: Cache node_modules ğŸ“¦
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: Merge branch ğŸ’¡
        run: |
          git checkout $BUILD_BRANCH
          git fetch origin $BUILD_BRANCH
          git merge $BASE_BRANCH --no-ff -m "merge $BASE_BRANCH"

      - name: Install modules ğŸ§¶
        run: yarn

      # env
      - name: Get Env Values
        id: nuxt_public
        run: |
          echo "::set-output name=env::$(cat .env.json | tr -d '\n')"

      - name: Get Environment Variables for Application
        run: |
          echo "BASE_URL=${{ fromJson(steps.nuxt_public.outputs.env)[env.BASE_BRANCH].BASE_URL }}" >> $GITHUB_ENV
          echo "GA_ID=${{ fromJson(steps.nuxt_public.outputs.env)[env.BASE_BRANCH].GA_ID }}" >> $GITHUB_ENV
          echo "GTM_ID=${{ fromJson(steps.nuxt_public.outputs.env)[env.BASE_BRANCH].GTM_ID }}" >> $GITHUB_ENV

      - name: log
        run: echo $GITHUB_ENV

      - name: Build ğŸ”¨
        run: $BUILD

      - name: Push build files ğŸ“¨
        run: |
          git add .
          git commit -m "build: automatic build" || true
          git pull origin $BUILD_BRANCH
          git push -f origin $BUILD_BRANCH

# name: CI generate

# env:
#   DEVELOP: develop
#   STAGING: main

# on:
#   push:
#     branches:
#       - develop

# jobs:
#   generate:
#     runs-on: ${{ matrix.os }}

#     strategy:
#       matrix:
#         os: [ubuntu-latest]
#         node: [14]

#     steps:
#       - name: Checkout ğŸ›
#         uses: actions/checkout@v2
#         with:
#           fetch-depth: 0

#       - name: Setup node env ğŸ—
#         uses: actions/setup-node@v2.1.5
#         with:
#           node-version: ${{ matrix.node }}

#       - name: Setup config ğŸ“
#         run: |
#           git config --local user.email "githubactions@example.com"
#           git config --local user.name "github actions"
#           git config --local pull.rebase false

#       - name: Get yarn cache directory path ğŸ› 
#         id: yarn-cache-dir-path
#         run: echo "::set-output name=dir::$(yarn cache dir)"

#       - name: Cache node_modules ğŸ“¦
#         uses: actions/cache@v2.1.5
#         id: yarn-cache
#         with:
#           path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
#           key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
#           restore-keys: |
#             ${{ runner.os }}-yarn-

#       - name: Merge branch ğŸ’¡
#         run: |
#           git checkout $STAGING
#           git fetch origin $STAGING
#           git merge $DEVELOP --no-ff -m "merge $DEVELOP"

#       - name: Install modules ğŸ§¶
#         run: yarn

#       - name: Generate files ğŸ”¨
#         run: yarn generate

#       - name: Push generate files ğŸ“¨
#         run: |
#           git add .
#           git commit -m "build: nuxt generate" || true
#           git pull origin $STAGING
#           git push -f origin $STAGING

      - name: Auto generate failed notification ğŸ“©
        uses: miyabin66/ganotify@main
        if: failure()  # å¤±æ•—ã—ãŸæ™‚ã«Slackã¸é€šçŸ¥
        with:
          type: ${{ job.status }} # jobã®æˆå¦ã‚’ä»£å…¥(Failure/Success)
          job_name: '*Auto Nuxt Generate* ${{ job.status }}'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
