name: CI develop build

# ç’°å¢ƒå¤‰æ•°ã®ä¸­èº«ã‚’ãŠä½¿ã„ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„
env:
  BRANCHES: '{ "develop": "develop-site" }'
  BUILD: yarn generate

# ã“ã“ã¯run:ã§ã¯ç„¡ã„ã®ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã§ãã¾ã›ã‚“ã€‚developãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å¤‰æ›´ã™ã‚‹å ´åˆã¯æ‰‹å‹•ã§å¤‰æ›´ã—ã¦ãã ã•ã„
on:
  push:
    branches:
      - develop

jobs:
  generate:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest]
        node: [14]

    steps:
      - name: Get base branch name
        run: echo "BASE_BRANCH=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_ENV

      - name: Get build branch name
        run: echo "BUILD_BRANCH=${{ fromJson(env.BRANCHES)[env.BASE_BRANCH] }}" >> $GITHUB_ENV

      - name: Checkout ðŸ›Ž
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup node env ðŸ—
        uses: actions/setup-node@v2.1.3
        with:
          node-version: ${{ matrix.node }}

      - name: Setup config ðŸ“
        run: |
          git config --local user.email "githubactions@example.com"
          git config --local user.name "github actions"
          git config --local pull.rebase false

      - name: Get yarn cache directory path ðŸ› 
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: Cache node_modules ðŸ“¦
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: Merge branch ðŸ’¡
        run: |
          git checkout $BUILD_BRANCH
          git fetch origin $BUILD_BRANCH
          git merge $BASE_BRANCH --no-ff -m "merge $BASE_BRANCH"

      - name: Install modules ðŸ§¶
        run: yarn

      # env
      - name: get env file
        id: nuxt_public
        run: |
          echo "::set-output name=env::$(cat .env.json | tr -d '\n')"

      - name: Get Environment Variables for Application
        run: |
          echo "BASE_URL=${{ fromJson(steps.next_public.outputs.env)[env.BASE_BRANCH].BASE_URL }}" >> $GITHUB_ENV
          echo "GA_ID=${{ fromJson(steps.next_public.outputs.env)[env.BASE_BRANCH].GA_ID }}" >> $GITHUB_ENV
          echo "GTM_ID=${{ fromJson(steps.next_public.outputs.env)[env.BASE_BRANCH].GTM_ID }}" >> $GITHUB_ENV

      - name: Build ðŸ”¨
        run: $BUILD

      - name: Push build files ðŸ“¨
        run: |
          git add .
          git commit -m "build: automatic build" || true
          git pull origin $BUILD_BRANCH
          git push -f origin $BUILD_BRANCH
